<div class="card min-w-full">
  <div class="card-header">
    <h3 class="card-title">Contenedores</h3>

    <app-button
      routerLink="/contenedor/nuevo"
      type="button"
      texto="Nuevo"
    ></app-button>
  </div>
  <div class="card-body">
    <div class="flex mb-4">
      <div class="input w-1/3 relative">
        <i
          class="ki-outline ki-magnifier absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500"
        ></i>
        <input
          placeholder="Buscar por nombre"
          type="text"
          [(ngModel)]="searchTerm"
          (ngModelChange)="onSearchChange($event)"
          class="pl-10 border-gray-300 transition-all duration-200"
        />
      </div>
    </div>
  </div>
  <div class="card-table scrollable-x-auto">
    <table class="table align-middle text-gray-700 font-medium text-sm">
      <thead>
        <tr>
          <th>Nombre</th>
          <th></th>
          <th>Plan</th>
          <th>Usuarios</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        @for (contenedor of arrContenedores; let idx = $index; track idx;) {
        <tr>
          <td class="flex items-center">
            <ng-container *ngIf="contenedor.contenedor__imagen">
              <img
                [src]="digitalOceanUrl + contenedor.contenedor__imagen"
                [alt]="'Error al cargar logo'"
                width="120"
                height="120"
                style="min-width: 120px"
                class="img-thumbnail border border-1 rounded-lg"
              />
            </ng-container>

            <div class="flex flex-col items-start ml-4">
              <span class="text-dark font-bold">
                {{ contenedor.contenedor__nombre }}
              </span>
              <span class="text-slate-400 mb-3 text-xs"
                >{{ contenedor.contenedor__schema_name }}{{ dominioApp }}</span
              >
              <div>
                <span class="badge badge-outline badge-xs">{{
                  contenedor.rol
                }}</span>
                @if (contenedor.acceso_restringido) {
                <span
                  class="inline-block bg-red-50 text-red-700 px-2 py-1 rounded text-xs font-bold whitespace-normal text-left w-full mt-1"
                >
                  El acceso a este contenedor est√° temporalmente suspendido. Por
                  favor, revise su cuenta o la del propietario para solucionar
                  el inconveniente
                </span>
                }
              </div>
            </div>
          </td>
          <td></td>
          <td>
            <div>
              <span class="badge badge-outline badge-success">{{
                contenedor.contenedor__plan__nombre
              }}</span>
            </div>
          </td>
          <td>
            <div class="text-xs">
              {{ contenedor.contenedor__usuarios }} /
              {{ contenedor.contenedor__plan__usuarios_base }}
            </div>
          </td>
          <td>
            <div class="flex gap-4">
              <app-button
                [estaDeshabilitado]="
                  contenedor.acceso_restringido && contenedor.rol !== 'control'
                "
                (emitirBotonClicked)="
                  seleccionarEmpresa(contenedor.contenedor_id, idx)
                "
                [texto]="'Conectar'"
                textoCargando="Espere..."
                [estaCargando]="arrConectando[idx]"
              ></app-button>
              <div *ngIf="contenedor.rol === 'propietario'">
                <div
                  class="dropdown"
                  data-dropdown="true"
                  data-dropdown-trigger="click"
                  data-dropdown-dismiss="true"
                >
                  <button class="dropdown-toggle btn btn-light">
                    <i class="ki-filled ki-setting-2"></i>
                  </button>
                  <div class="dropdown-content w-full max-w-36 py-2">
                    <div class="menu menu-default flex flex-col w-full">
                      <div class="menu-item">
                        <button
                          (click)="
                            seleccionarContenedorParaEliminar(contenedor);
                            abrirModal()
                          "
                          class="menu-link"
                          data-modal-toggle="#invitarContenedor"
                        >
                          <span class="menu-icon">
                            <i class="ki-filled ki-users"></i>
                          </span>
                          <span class="menu-title"> Invitar </span>
                        </button>
                      </div>
                      <div class="menu-item">
                        <button
                          (click)="handleEliminarClick(contenedor)"
                          class="menu-link"
                          data-modal-toggle="#eliminarContenedor"
                        >
                          <span class="menu-icon">
                            <i class="ki-filled ki-trash"></i>
                          </span>
                          <span class="menu-title"> Eliminar </span>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </td>
        </tr>
        }
      </tbody>
    </table>

    <!-- Paginador component -->
    @if(arrContenedores.length > 0){
    <div class="flex justify-center my-4">
      <app-paginador
        (pageChange)="cambiarPaginacion($event)"
        [totalItems]="totalItems"
        [currentPage]="currentPage()"
      ></app-paginador>
    </div>
    }
  </div>
</div>

<!-- Eliminar contenedor -->

<app-modal-standard
  title="Eliminar contenedor"
  size="md"
  modalId="eliminarContenedor"
>
  @if (getModalInstaceState('eliminarContenedor') | async) {
  <app-contenedor-eliminar
    [contenedor]="contenedor"
    (emitirEliminarContenedor)="eliminarContenedor()"
    (emitirModalCerrado)="closeModal('eliminarContenedor')"
  ></app-contenedor-eliminar>
  }
</app-modal-standard>

<!-- Enviar invitacion -->

<app-modal-default
  titulo="Invitaciones"
  size="medium"
  [id]="'invitarContenedor'"
  (emitirModalCerrado)="cerrarModal()"
>
  <div *ngIf="toggleModal$ | async" modal-body>
    <app-contenedor-invitar [contenedor]="contenedor"></app-contenedor-invitar>
  </div>
</app-modal-default>
