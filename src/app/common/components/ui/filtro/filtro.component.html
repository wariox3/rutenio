<div class="filter-container mb-3 space-y-2">
  <div
    *ngFor="let condition of filterConditions; let i = index"
    class="filter-row flex flex-wrap items-center gap-2"
  >
    <!-- Campo -->
    <div class="w-full md:w-1/3">
      <select
        class="select"
        [(ngModel)]="condition.field"
        (change)="onFieldChange(condition, i)"
      >
        <option value="">Seleccionar campo</option>
        <option *ngFor="let field of availableFields" [value]="field.name">
          {{ field.displayName }}
        </option>
      </select>
    </div>

    <!-- Operador -->
    <div class="w-full md:w-1/4">
      <select
        class="select"
        [(ngModel)]="condition.operator"
        [disabled]="!condition.field"
      >
        <option value="">Seleccionar operador</option>
        <option
          *ngFor="let op of getOperatorsForField(condition.field)"
          [value]="op.symbol"
        >
          {{ op.name }}
        </option>
      </select>
    </div>

    <!-- Valor -->
    <div class="w-full md:w-1/4">
      <ng-container [ngSwitch]="getInputType(condition.field)">
        <!-- Boolean -->
        <select
          #valueInputElement
          *ngSwitchCase="'boolean'"
          class="select"
          [(ngModel)]="condition.value"
          [disabled]="!condition.operator"
          (keydown.enter)="handleEnterKey()"
        >
          <option [ngValue]="true">Sí</option>
          <option [ngValue]="false">No</option>
        </select>

        <!-- Relation -->
        <div *ngSwitchCase="'relation'" class="relative">
          @if(condition.multiple){
          <app-multi-select
            [options]="getRelationOptions(condition.field)"
            [label]="'display'"
            [value]="'value'"
            (selectionChange)="
              onRelationOptionSelectedMultiple(condition, {
                value: $event,
                display: condition.field
              })"
          ></app-multi-select>
          } @else {
          <div
            class="dropdown"
            data-dropdown="true"
            data-dropdown-trigger="click"
            data-dropdown-dismiss="true"
          >
            <input
              #valueInputElement
              type="text"
              class="input dropdown-toggle"
              [placeholder]="getPlaceholder(condition.field)"
              [value]="condition.displayValue || ''"
              [(ngModel)]="searchTerms[condition.field]"
              (input)="
                onRelationSearch(condition.field, searchTerms[condition.field])
              "
              (focus)="
                onRelationSearch(condition.field, searchTerms[condition.field])
              "
            />
            <div
              class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400"
            >
              <i class="ki-filled ki-filter-search"></i>
            </div>
            <div class="dropdown-content w-full max-w-56 py-2">
              <div class="menu menu-default flex flex-col w-full">
                <div
                  class="menu-item"
                  *ngFor="let item of getRelationOptions(condition.field)"
                >
                  <button
                    class="menu-link"
                    (click)="onRelationOptionSelected(condition, item)"
                  >
                    <span class="menu-title">{{ item.display }}</span>
                  </button>
                </div>
                <div
                  *ngIf="getRelationOptions(condition.field)?.length === 0"
                  lass="menu-item"
                >
                  No se encontraron resultados
                </div>
              </div>
            </div>
          </div>
          }
        </div>

        <!-- Default -->
        <input
          #valueInputElement
          *ngSwitchDefault
          type="{{ getInputType(condition.field) }}"
          class="input"
          [(ngModel)]="condition.value"
          [disabled]="!condition.operator"
          [placeholder]="getPlaceholder(condition.field)"
          (keydown.enter)="handleEnterKey()"
        />
      </ng-container>
    </div>

    <!-- Botones agregar/quitar -->
    <div class="flex gap-1 w-full md:w-auto">
      <button
        class="text-red-500 hover:bg-red-50 text-sm px-2 py-1 rounded"
        (click)="removeFilterCondition(i)"
        [disabled]="filterConditions.length <= 1"
      >
        <i class="ki-filled ki-minus"></i>
      </button>
      <button
        class="text-blue-500 hover:bg-blue-50 text-sm px-2 py-1 rounded"
        (click)="addFilterCondition()"
      >
        <i class="ki-filled ki-plus"></i>
      </button>
    </div>
  </div>

  <!-- Botones de acción -->
  <div class="flex justify-end gap-2 mt-3">
    <button class="mr-1 btn btn-secondary" (click)="clearAllFilters()">
      Limpiar
    </button>
    <button class="btn btn-outline btn-primary" (click)="applyFilters()">
      Filtrar
    </button>
  </div>
</div>
